<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Title</title>
	<link href="../static/styles/style.css" rel="stylesheet" type="text/css"/>
	<script src="https://ajax.googleapis.com/ajax/libs/d3js/5.9.0/d3.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
	<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
	<!--    <script src="../static/sentence.js"></script>-->
</head>
<body class="unscrollable">
<div class="training_page_baseline flex_column">
	<div class="title_bar">
		<div class="title_logo">Visual Fasttext</div>
		<div class="title_id" id="id">ID: </div>
		<div class="title_ready_btn" id="evaluate">Evaluate</div>
		<div class="title_ready_btn invisible" id="ready" onclick="rating()">Ready</div>
	</div>
	<div class="training_row_alone flex_row">
		<div id="left_sidebar" class="sidebar_training">
			<div class="tuning">
				<!--lr-->
				<div class="hyperparameter">
					<div class="slider_label">
						<div class="left main">Learning Rate:</div>
						<div id="lr_value" class="right main"></div>
					</div>
					<div class="slidecontainer">
						<input type="range" min="0.001" max="0.15" value="0.1" class="slider" step="0.001" id="lr_range">
					</div>
				</div>
				<!--lrUpdateRate-->
				<div class="hyperparameter">
					<div class="slider_label">
						<div class="left main">Learning Rate Update Rate:</div>
						<div id="lrUpdateRate_value" class="right main"></div>
					</div>
					<div class="slidecontainer">
						<input type="range" min="50" max="200" value="100" class="slider" step="10" id="lrUpdateRate_range">
					</div>
				</div>
				<!--dim-->
				<div class="hyperparameter">
					<div class="slider_label">
						<div class="left main">Dimension of the Word Vector:</div>
						<div id="dim_value" class="right main"></div>
					</div>
					<div class="slidecontainer">
						<input type="range" min="1" max="200" value="100" class="slider" step="1" id="dim_range">
					</div>
				</div>
				<!--ws-->
				<div class="hyperparameter">
					<div class="slider_label">
						<div class="left main">Context Window:</div>
						<div id="ws_value" class="right main"></div>
					</div>
					<div class="slidecontainer">
						<input type="range" min="1" max="15" value="64" class="slider" step="1" id="ws_range">
					</div>
				</div>
				<!--epoch-->
				<div class="hyperparameter">
					<div class="slider_label">
						<div class="left main">Epoches:</div>
						<div id="epoch_value" class="right main"></div>
					</div>
					<div class="slidecontainer">
						<input type="range" min="1" max="40" value="5" class="slider" step="1" id="epoch_range">
					</div>
				</div>
				<!--minCount-->
				<div class="hyperparameter">
					<div class="slider_label">
						<div class="left main">Minimal Word Occurences:</div>
						<div id="minCount_value" class="right main"></div>
					</div>
					<div class="slidecontainer">
						<input type="range" min="1" max="5" value="1" class="slider" step="1" id="minCount_range">
					</div>
				</div>
				<!--neg-->
				<div class="hyperparameter">
					<div class="slider_label">
						<div class="left main">Number of Negatives Sampled:</div>
						<div id="neg_value" class="right main"></div>
					</div>
					<div class="slidecontainer">
						<input type="range" min="1" max="10" value="5" class="slider" step="1" id="neg_range">
					</div>
				</div>
				<!--wordNgrams-->
				<div class="hyperparameter">
					<div class="slider_label">
						<div class="left main">Word N-gram:</div>
						<div id="wordNgrams_value" class="right main"></div>
					</div>
					<div>
						<ul class="radio_list">
							<li>
								<input type="radio" id="wordNgrams_1" name="wordNgrams_select" checked="checked"/>
								<label for="wordNgrams_1">1</label>
							</li>
							<li>
								<input type="radio" id="wordNgrams_2" name="wordNgrams_select"/>
								<label for="wordNgrams_2">2</label>
							</li>
						</ul>
						<div class="clearfloat"></div>
					</div>
				</div>
				<!--loss-->
				<div class="hyperparameter">
					<div class="slider_label">
						<div class="left main">Loss Function:</div>
						<div id="loss_value" class="right main"></div>
					</div>
					<div>
						<ul class="radio_list">
							<li>
								<input type="radio" id="loss_ns" name="loss_select"/>
								<label for="loss_ns">ns</label>
							</li>
							<li>
								<input type="radio" id="loss_hs" name="loss_select"/>
								<label for="loss_hs">hs</label>
							</li>
							<li>
								<input type="radio" id="loss_softmax" name="loss_select" checked="checked"/>
								<label for="loss_softmax">softmax</label>
							</li>
						</ul>
						<div class="clearfloat"></div>
					</div>
				</div>
				<!--minn-->
				<div class="hyperparameter">
					<div class="slider_label">
						<div class="left main">Minimal Character N-gram:</div>
						<div id="minn_value" class="right main"></div>
					</div>
					<div class="slidecontainer">
						<input type="range" min="0" max="3" value="0" class="slider" step="1" id="minn_range">
					</div>
				</div>
				<!--maxx-->
				<div class="hyperparameter">
					<div class="slider_label">
						<div class="left main">Maximal Character N-gram:</div>
						<div id="maxn_value" class="right main"></div>
					</div>
					<div class="slidecontainer">
						<input type="range" min="0" max="3" value="0" class="slider" step="1" id="maxn_range">
					</div>
				</div>
				<!--t-->
				<div class="hyperparameter">
					<div class="slider_label">
						<div class="left main">Sampling Threshold:</div>
						<div id="t_value" class="right main"></div>
					</div>
					<div>
						<ul class="radio_list">
							<li>
								<input type="radio" id="t_10e-6" name="t_select"/>
								<label for="t_10e-6">0.00001</label>
							</li>
							<li>
								<input type="radio" id="t_10e-5" name="t_select" checked="checked">
								<label for="t_10e-5">0.0001</label>
							</li>
							<li>
								<input type="radio" id="t_10e-4" name="t_select"/>
								<label for="t_10e-4">0.001</label>
							</li>
						</ul>
						<div class="clearfloat"></div>
					</div>
				</div>
			</div>
			<div class="button_panel">
				<button id="start" class="button button_start button_control">Start</button>
				<button id="stop" class="button button_stop button_control">Stop</button>
			</div>
		</div>
		<div id="container_main_left_baseline" class="container_main_left_baseline">
			<div id="terminal" class="full_width training_scatter_container_baseline terminal">
				<div id="terminal0">
					<a class="terminal_header">[visual-fasttext]</a>
				</div>
				<div id="terminal1"></div>
				<div id="terminal2"></div>
				<div id="terminal3"></div>
				<div id="terminal_end"></div>
			</div>
		</div>
		<div class="cm_container_baseline">
			<div id="container_main_training_baseline" class="main container_main_training_baseline">
				<div id="cm" class="center"></div>
				<div id="cm_loading" class="center">
					<div id="loader" class="invisible"></div>
				</div>
			</div>
		</div>
<!--		<div id="container_main" class="container_main_training_baseline">-->
<!--		</div>-->
	</div>
</div>
<script>

	document.getElementById("id").innerHTML = "No. {{id}}";

	const zValues = [
			[66, 416, 309, 116, 34, 33, 15, 7, 4, 0],
			[21, 253, 378, 197, 74, 40, 22, 13, 2, 0],
			[12, 165, 349, 269, 92, 58, 35, 16, 3, 1],
			[0, 80, 289, 312, 142, 94, 52, 25, 6, 0],
			[1, 32, 171, 276, 193, 168, 99, 44, 16, 0],
			[0, 8, 93, 200, 194, 192, 189, 102, 20, 2],
			[0, 9, 40, 112, 130, 200, 266, 181, 57, 5],
			[0, 3, 25, 73, 81, 140, 247, 275, 144, 12],
			[0, 4, 23, 59, 56, 127, 182, 287, 242, 20],
			[1, 12, 19, 50, 58, 82, 159, 247, 311, 61]
		];

	// plot_cm(zValues);

	function plot_cm(zMatrix) {
		const range = (start, end, length = end - start) => Array.from({ length }, (_, i) => start + i);

		const xValues = ['1 star', '2 stars', '3 stars', '4 stars', '5 stars', '6 stars', '7 stars', '8 stars', '9 stars', '10 stars'];
		const yValues = ['1 star', '2 stars', '3 stars', '4 stars', '5 stars', '6 stars', '7 stars', '8 stars', '9 stars', '10 stars'];
		const zValues = zMatrix;
		const maxRow = zValues.map(function(row){ return Math.max.apply(Math, row); });
		const max_zValue = Math.max.apply(null, maxRow);

		var data_cm = [
			{
				x: xValues,
				y: yValues,
				z: zValues,
				colorscale: [['0.0', '#FBF8F5'],['0.1', '#F9F1EC'],['0.2', '#EED4CD'],['0.3', '#E4B8B8'],['0.4', '#D69CA8'],['0.5', '#C5849D'],['0.6', '#A7658E'],['0.7', '#8C5181'],['0.8', '#6C3F70'],['0.9', '#4C2E5A'], ['1.0', '#2D1E3E']],
				reversescale: false,
				type: 'heatmap'
			}
		];

		var layout_cm = {
			paper_bgcolor: 'transparent',
			plot_bgcolor: 'transparent',
			title: '',
			annotations: [],
			xaxis: {
				title: "Prediction",
				ticks: '',
				// ticksuffix: ' ',
				side: 'top',
				fixedrange: true
			},
			yaxis: {
				title: "Truth",
				ticks: '',
				ticksuffix: ' ',
				autosize: true,
				autorange: 'reversed',
				fixedrange: true
			},
			hovermode: false,
			// autosize: true,
			margin: {
				l: 75,
				r: 20,
				b: 65,
				t: 70,
				// pad: 50
			},
			width: 450,
			height: 450
		};

		for ( let i = 0; i < yValues.length; i++ ) {
			for ( let j = 0; j < xValues.length; j++ ) {
				const currentValue = zValues[i][j];
				const percentile = currentValue / max_zValue;
				let textColor = '';
				if (percentile > 0.35) {
					textColor = 'white';
				} else {
					textColor = 'black';
				}
				var result = {
					xref: 'x1',
					yref: 'y1',
					x: xValues[j],
					y: yValues[i],
					text: zValues[i][j],
					font: {
						// family: 'Arial',
						size: 12,
						color: textColor
					},
					showarrow: false,
				};
				layout_cm.annotations.push(result);
			}
		}

		Plotly.newPlot('cm', data_cm, layout_cm);
	}
</script>
<script>
	//Push-up
	var source = new EventSource("{{ url_for('sse.stream') }}");
	source.addEventListener('greeting', function(event) {
		JSON.parse(event.data, function(k, v) {
			if (k === 'message') {
				// document.getElementById("terminal_end").innerHTML += v;
				JSON.parse(v, function (k2, v2) {
					if (k2 === "cm") {
						// document.getElementById("TestDIV").innerHTML += "<br>k: " + k + " v: " + v;
						let cm = JSON.parse(v2);
						console.log(cm);
						plot_cm(cm);
						document.getElementById("loader").className = "invisible";
					} else if (k2 === "loading_data") {
						document.getElementById("terminal1").innerHTML = v2;
					} else if (k2 === "training_progress") {
						document.getElementById("terminal2").innerHTML = v2;
					} else if (k2 === "evaluating") {
						console.log("sss");
						document.getElementById("terminal3").innerHTML += v2 + "<br />";
					}
					return 0;
				});
			}
			return 0;
		});
	}, false);

	source.addEventListener('error', function(event) {
		alert("Failed to communicate with the server");
	}, false);
</script>
<script>
	hyperparameters = ['lr', 'lrUpdateRate', 'dim', 'ws', 'epoch', 'minCount', 'neg', 'wordNgrams', 'loss', 'minn', 'maxn', 't'];
	for (let hp of hyperparameters) {
		let range = document.getElementById(hp + "_range");
		let value = document.getElementById(hp + "_value");
		if (range != null) {
			value.innerHTML = range.value;
			range.oninput = function() {
				value.innerHTML = this.value;
			}
		}
	}
</script>
<script>
	// $(function() {
	// 	$("#start").bind('click', function() {
	// 		$.getJSON('/start', function() {
	//
	// 		});
	// 		return false;
	// 	});
	// });

	let group_no = 1;
	let round = 1;

	$(function() {
		$("#start").click(function() {

			document.getElementById("terminal0").innerHTML = "<a class=\"terminal_header\">[visual-fasttext]</a> ./fasttext supervised -input imdb.train -output model.bin -arg args.txt";
			document.getElementById("terminal1").innerHTML = "";
			document.getElementById("terminal2").innerHTML = "";
			document.getElementById("terminal3").innerHTML = "";
			document.getElementById("terminal_end").innerHTML = "";
			document.getElementById("cm").innerHTML = "";
			document.getElementById("loader").className = "loader";
			let conf = {};

			for (let hp of hyperparameters) {
				const target_text = document.getElementById(hp + "_range");
				const target_radios = document.getElementsByName(hp + "_select");
				if (target_text != null) {
					conf[hp] = parseFloat(target_text.value);
				} else {
					let radio_value = "";
					for (let i = 0, length = target_radios.length; i < length; i++) {
						if (target_radios[i].checked) {
							radio_value = target_radios[i].value;
							break;
						}
					}
				}
			}

			$.post({url: "/start", data: JSON.stringify({subj_id: "{{id}}", group: group_no, training_round: round, kwargs: conf}), success: function() {}});
			return false;
		});
	});

	$(function() {
		$("#evaluate").bind('click', function() {
			$.getJSON('/start', function() {

			});
			return false;
		});
	});

	$(function() {
		$("#evaluate").click(function() {

			document.getElementById("evaluate").className = "title_ready_btn invisible";
			document.getElementById("ready").className = "title_ready_btn";
			document.getElementById("left_sidebar").className = "sidebar_training invisible";
			// document.getElementById("container_main_left_baseline").className = "container_main_left_baseline invisible";
			// document.getElementById("container_main_training_baseline").className = "container_main_left_baseline invisible";

			document.getElementById("loader").className = "loader";
			document.getElementById('cm').innerHTML = "";

			$.post({url: "/start", data: JSON.stringify({subj_id: "{{id}}", group: group_no, training_round: round, kwargs: {}}), success: function() {}});
			return false;
		});
	});

	$(function() {
		$("#stop").bind('click', function() {
			$.getJSON('/stop', function() {});
			return false;
		});
	});

	function rating() {
		window.open("/rating?id={{ id }}");
		return false;
	}
</script>
</body>
</html>